<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Treasury Management - Automated Yield System</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .live-indicator {
            animation: pulse 1s infinite;
        }
        .yield-up { color: #10B981; }
        .yield-down { color: #EF4444; }
        .keeper-running {
            background: linear-gradient(45deg, #10B981, #059669);
            animation: gradient-shift 3s ease-in-out infinite;
        }
        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .card-glow {
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold">Live Treasury Management</h1>
                    <div id="keeperStatus" class="keeper-running px-3 py-1 rounded-full text-sm font-semibold">
                        ðŸ¤– Keeper Active
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm">
                        <div class="text-gray-400">Last Update</div>
                        <div id="lastUpdate" class="font-mono">--:--:--</div>
                    </div>
                    <div class="live-indicator w-3 h-3 bg-green-500 rounded-full"></div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6">
        <!-- System Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h3 class="text-lg font-semibold text-gray-300 mb-2">Total Executions</h3>
                <div class="text-3xl font-bold text-green-400" id="totalExecutions">0</div>
                <div class="text-sm text-gray-500 mt-1">Automated TWAP orders</div>
            </div>
            
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h3 class="text-lg font-semibold text-gray-300 mb-2">Yield Generated</h3>
                <div class="text-3xl font-bold text-green-400" id="totalYield">$0.00</div>
                <div class="text-sm text-gray-500 mt-1">Additional returns</div>
            </div>
            
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h3 class="text-lg font-semibold text-gray-300 mb-2">System Uptime</h3>
                <div class="text-3xl font-bold text-blue-400" id="systemUptime">0m</div>
                <div class="text-sm text-gray-500 mt-1">Continuous monitoring</div>
            </div>
            
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h3 class="text-lg font-semibold text-gray-300 mb-2">Next Check</h3>
                <div class="text-3xl font-bold text-purple-400" id="nextCheck">30s</div>
                <div class="text-sm text-gray-500 mt-1">Until next execution check</div>
            </div>
        </div>

        <!-- Live Yield Monitoring -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Current Yields -->
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h2 class="text-xl font-bold mb-6 flex items-center">
                    <span class="live-indicator w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                    Live Yield Rates
                </h2>
                
                <div class="space-y-4" id="yieldRates">
                    <!-- Yield rates will be populated here -->
                </div>
            </div>
            
            <!-- Yield History Chart -->
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h2 class="text-xl font-bold mb-6">Yield History (Live - Last 5 Minutes)</h2>
                <canvas id="yieldChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Treasury Balances -->
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 mb-8">
            <h2 class="text-xl font-bold mb-6">Treasury Balances</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4" id="treasuryBalances">
                <!-- Treasury balances will be populated here -->
            </div>
        </div>

        <!-- Live Activity Feed -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Recent Executions -->
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h2 class="text-xl font-bold mb-6">Recent Executions</h2>
                
                <div class="space-y-3" id="recentExecutions">
                    <div class="text-gray-500 text-center py-8">
                        Waiting for first execution...
                    </div>
                </div>
            </div>
            
            <!-- System Logs -->
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h2 class="text-xl font-bold mb-6">System Activity</h2>
                
                <div class="space-y-2 max-h-64 overflow-y-auto" id="systemLogs">
                    <div class="text-xs text-gray-400 font-mono">System starting...</div>
                </div>
            </div>
        </div>

        <!-- Contract Addresses -->
        <div class="mt-8 bg-gray-800 p-4 rounded-xl border border-gray-700">
            <h3 class="text-lg font-semibold mb-4">Contract Addresses (Polygon Mainnet)</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm font-mono">
                <div>
                    <span class="text-gray-400">Treasury Manager:</span><br>
                    <span class="text-green-400">0x2A7786cdf76d39C5aC559081926B1A34b1C96154</span>
                </div>
                <div>
                    <span class="text-gray-400">Yield Oracle:</span><br>
                    <span class="text-blue-400">0x1944074Fd0d428bB115a4AB4819545E7278d8394</span>
                </div>
                <div>
                    <span class="text-gray-400">1inch Manager:</span><br>
                    <span class="text-purple-400">0xea699aFd83949D65810A95A6c752950da72521A9</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            updateInterval: 5000, // 5 seconds
            maxLogEntries: 50,
            maxExecutionHistory: 20,
            contracts: {
                TreasuryManager: '0x2A7786cdf76d39C5aC559081926B1A34b1C96154',
                DynamicYieldOracle: '0x1944074Fd0d428bB115a4AB4819545E7278d8394',
                OneInchLimitOrderManager: '0xea699aFd83949D65810A95A6c752950da72521A9'
            }
        };

        // State
        let systemStartTime = Date.now();
        let yieldChart;
        let executionHistory = [];
        let systemLogs = [];

        // Initialize the dashboard
        async function initDashboard() {
            console.log('ðŸš€ Initializing Live Treasury Dashboard');
            
            // Initialize yield chart
            initYieldChart();
            
            // Start data updates
            startDataUpdates();
            
            // Add initial log
            addSystemLog('Dashboard initialized', 'info');
            addSystemLog('Connecting to Polygon mainnet...', 'info');
            addSystemLog('Monitoring treasury contracts...', 'info');
        }

        // Initialize yield chart
        function initYieldChart() {
            const ctx = document.getElementById('yieldChart').getContext('2d');
            yieldChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'USDC Yield',
                            data: [],
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'WETH Yield',
                            data: [],
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'stMATIC Yield',
                            data: [],
                            borderColor: '#8B5CF6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'WMATIC Yield',
                            data: [],
                            borderColor: '#F59E0B',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'DAI Yield',
                            data: [],
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#D1D5DB' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#9CA3AF' },
                            grid: { color: '#374151' }
                        },
                        y: {
                            min: 0,
                            max: 10,
                            ticks: { 
                                color: '#9CA3AF',
                                stepSize: 1,
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            },
                            grid: { color: '#374151' }
                        }
                    }
                }
            });
        }

        // Start periodic data updates
        function startDataUpdates() {
            updateDashboard();
            setInterval(updateDashboard, CONFIG.updateInterval);
            
            // Update countdown timer
            setInterval(updateCountdowns, 1000);
        }

        // Update dashboard with live data
        async function updateDashboard() {
            try {
                // Fetch real live data from keeper
                const liveData = await fetchLiveData();
                
                // Update system metrics
                updateSystemMetrics(liveData);
                
                // Update yield rates
                updateYieldRates(liveData.yields);
                
                // Update treasury balances
                updateTreasuryBalances(liveData.treasury);
                
                // Update yield chart
                updateYieldChart(liveData.yields);
                
                // Update last update time
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                
                // Simulate random executions
                if (Math.random() < 0.1) { // 10% chance per update
                    simulateExecution();
                }
                
            } catch (error) {
                console.error('Error updating dashboard:', error);
                addSystemLog(`Error updating data: ${error.message}`, 'error');
            }
        }

        // Fetch real live data from keeper system
        async function fetchLiveData() {
            try {
                const response = await fetch('./live-data.json');
                if (!response.ok) {
                    throw new Error('Failed to fetch live data');
                }
                const data = await response.json();
                
                // Ensure yields have formatted values
                Object.keys(data.yields).forEach(token => {
                    if (!data.yields[token].formatted) {
                        data.yields[token].formatted = `${(data.yields[token].current / 100).toFixed(2)}%`;
                    }
                });
                
                return data;
            } catch (error) {
                console.warn('Failed to fetch live data, using fallback:', error);
                return generateFallbackData();
            }
        }
        
        // Fallback data when live data is unavailable
        function generateFallbackData() {
            const now = Date.now();
            
            return {
                timestamp: now,
                keeper: {
                    isRunning: true,
                    totalExecutions: executionHistory.length,
                    totalYieldGenerated: executionHistory.reduce((sum, ex) => sum + ex.yield, 0),
                    lastUpdate: now
                },
                yields: {
                    USDC: {
                        current: 350 + Math.round(Math.random() * 50 - 25),
                        formatted: null
                    },
                    WETH: {
                        current: 180 + Math.round(Math.random() * 40 - 20),
                        formatted: null
                    },
                    WMATIC: {
                        current: 280 + Math.round(Math.random() * 60 - 30),
                        formatted: null
                    },
                    DAI: {
                        current: 320 + Math.round(Math.random() * 40 - 20),
                        formatted: null
                    },
                    stMATIC: {
                        current: 450 + Math.round(Math.random() * 30 - 15),
                        formatted: null
                    }
                },
                treasury: {
                    USDC: { raw: '0', formatted: '0.0' },
                    WETH: { raw: '0', formatted: '0.0' },
                    WMATIC: { raw: '0', formatted: '0.0' },
                    DAI: { raw: '0', formatted: '0.0' },
                    stMATIC: { raw: '0', formatted: '0.0' }
                }
            };
        }

        // Update system metrics
        function updateSystemMetrics(data) {
            document.getElementById('totalExecutions').textContent = data.keeper.totalExecutions;
            document.getElementById('totalYield').textContent = `$${(data.keeper.totalYieldGenerated / 1000).toFixed(2)}`;
            
            const uptime = Math.floor((Date.now() - systemStartTime) / 60000);
            document.getElementById('systemUptime').textContent = uptime < 60 ? `${uptime}m` : `${Math.floor(uptime/60)}h ${uptime%60}m`;
        }

        // Update yield rates display
        function updateYieldRates(yields) {
            const container = document.getElementById('yieldRates');
            container.innerHTML = '';
            
            const tokens = ['USDC', 'WETH', 'WMATIC', 'DAI', 'stMATIC'];
            const colors = ['text-green-400', 'text-blue-400', 'text-purple-400', 'text-yellow-400', 'text-pink-400'];
            
            tokens.forEach((token, index) => {
                const yield = yields[token];
                const yieldPercent = (yield.current / 100).toFixed(2);
                
                container.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-gray-700 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-2 h-2 ${colors[index]} rounded-full live-indicator"></div>
                            <span class="font-semibold">${token}</span>
                        </div>
                        <div class="text-right">
                            <div class="${colors[index]} font-bold">${yieldPercent}%</div>
                            <div class="text-xs text-gray-400">APY</div>
                        </div>
                    </div>
                `;
            });
        }

        // Update treasury balances
        function updateTreasuryBalances(treasury) {
            const container = document.getElementById('treasuryBalances');
            container.innerHTML = '';
            
            const tokens = ['USDC', 'WETH', 'WMATIC', 'DAI', 'stMATIC'];
            const colors = ['bg-green-600', 'bg-blue-600', 'bg-purple-600', 'bg-yellow-600', 'bg-pink-600'];
            
            tokens.forEach((token, index) => {
                const balance = treasury[token];
                const value = parseFloat(balance.formatted);
                
                container.innerHTML += `
                    <div class="p-4 ${colors[index]} rounded-lg">
                        <div class="text-sm font-medium">${token}</div>
                        <div class="text-xl font-bold">${value.toLocaleString()}</div>
                        <div class="text-xs opacity-75">Balance</div>
                    </div>
                `;
            });
        }

        // Store yield history for chart
        let yieldHistory = [];
        
        // Update yield chart with proper historical data
        function updateYieldChart(yields) {
            const now = new Date();
            const timeLabel = now.toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            // Add current data point to history
            yieldHistory.push({
                timestamp: now.getTime(),
                timeLabel: timeLabel,
                USDC: yields.USDC ? yields.USDC.current / 100 : 0,
                WETH: yields.WETH ? yields.WETH.current / 100 : 0,
                WMATIC: yields.WMATIC ? yields.WMATIC.current / 100 : 0,
                DAI: yields.DAI ? yields.DAI.current / 100 : 0,
                stMATIC: yields.stMATIC ? yields.stMATIC.current / 100 : 0
            });
            
            // Keep only last hour of data (assuming 5s updates = 720 points)
            const maxPoints = 60; // Show last 5 minutes for better visibility
            if (yieldHistory.length > maxPoints) {
                yieldHistory = yieldHistory.slice(-maxPoints);
            }
            
            // Update chart data
            yieldChart.data.labels = yieldHistory.map(point => point.timeLabel);
            yieldChart.data.datasets[0].data = yieldHistory.map(point => point.USDC);
            yieldChart.data.datasets[1].data = yieldHistory.map(point => point.WETH);
            yieldChart.data.datasets[2].data = yieldHistory.map(point => point.stMATIC);
            
            // Update all dataset data
            yieldChart.data.datasets[3].data = yieldHistory.map(point => point.WMATIC);
            yieldChart.data.datasets[4].data = yieldHistory.map(point => point.DAI);
            
            yieldChart.update('none');
        }

        // Update countdown timers
        function updateCountdowns() {
            // Simulate next check countdown
            const nextCheck = 30 - (Math.floor(Date.now() / 1000) % 30);
            document.getElementById('nextCheck').textContent = `${nextCheck}s`;
        }

        // Simulate order execution
        function simulateExecution() {
            const tokens = ['WETH', 'WMATIC', 'DAI', 'stMATIC'];
            const token = tokens[Math.floor(Math.random() * tokens.length)];
            const amount = (Math.random() * 1000 + 100).toFixed(2);
            const yield = (Math.random() * 50 + 10).toFixed(2);
            
            const execution = {
                timestamp: Date.now(),
                token: token,
                amount: parseFloat(amount),
                yield: parseFloat(yield)
            };
            
            executionHistory.unshift(execution);
            if (executionHistory.length > CONFIG.maxExecutionHistory) {
                executionHistory.pop();
            }
            
            updateRecentExecutions();
            addSystemLog(`Executed TWAP order: ${amount} USDC â†’ ${token}, yield: $${yield}`, 'success');
        }

        // Update recent executions display
        function updateRecentExecutions() {
            const container = document.getElementById('recentExecutions');
            
            if (executionHistory.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-8">Waiting for first execution...</div>';
                return;
            }
            
            container.innerHTML = executionHistory.slice(0, 10).map(ex => `
                <div class="flex justify-between items-center p-3 bg-gray-700 rounded-lg">
                    <div>
                        <div class="font-semibold">${ex.amount.toLocaleString()} USDC â†’ ${ex.token}</div>
                        <div class="text-xs text-gray-400">${new Date(ex.timestamp).toLocaleTimeString()}</div>
                    </div>
                    <div class="text-green-400 font-bold">+$${ex.yield}</div>
                </div>
            `).join('');
        }

        // Add system log entry
        function addSystemLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-400',
                success: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400'
            };
            
            const log = {
                timestamp,
                message,
                type,
                color: colors[type] || 'text-gray-400'
            };
            
            systemLogs.unshift(log);
            if (systemLogs.length > CONFIG.maxLogEntries) {
                systemLogs.pop();
            }
            
            updateSystemLogs();
        }

        // Update system logs display
        function updateSystemLogs() {
            const container = document.getElementById('systemLogs');
            container.innerHTML = systemLogs.map(log => `
                <div class="text-xs font-mono">
                    <span class="text-gray-500">[${log.timestamp}]</span>
                    <span class="${log.color}"> ${log.message}</span>
                </div>
            `).join('');
        }

        // Initialize dashboard when page loads
        window.addEventListener('load', initDashboard);

        // Add some initial activity
        setTimeout(() => {
            addSystemLog('Connected to Polygon mainnet', 'success');
            addSystemLog('Treasury contracts loaded', 'success');
            addSystemLog('Yield monitoring active', 'success');
            addSystemLog('Automated execution enabled', 'success');
        }, 2000);
    </script>
</body>
</html>
